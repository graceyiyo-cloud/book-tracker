import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, serverTimestamp, query } from 'firebase/firestore';
import { 
    BookOpen, Search, Plus, Trash2, CheckCircle, BookX, 
    Calendar, User, LogIn, RefreshCw, TrendingUp, Link as LinkIcon, 
    FileText, PenTool, Trophy, Hourglass, Star, X, Tag, RotateCcw, 
    AlertTriangle, Filter, LogOut, MessageSquare, Edit3, ChevronDown, 
    ExternalLink, Pin, PinOff, ChevronUp 
} from 'lucide-react';

// --- 環境變數初始化 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const ESTIMATE_WORDS_PER_PAGE = 350;
const DEFAULT_CATEGORIES = [
    "玄幻", "奇幻", "武俠", "仙俠", "都市", "言情", "古代", "架空", 
    "科幻", "懸疑", "推理", "驚悚", "恐怖", "冒險", "耽美", "百合", 
    "穿越", "重生", "系統", "快穿", "無限流", "末世", "種田", "宅鬥", "宮鬥"
];

// --- 子組件：分類選擇器 ---
const CategoryPicker = ({ selectedCategories, onToggle, allCategories, onAddNew, onDelete }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [filterText, setFilterText] = useState('');
    
    const filtered = useMemo(() => {
        const term = filterText.toLowerCase();
        return allCategories.filter(c => c.toLowerCase().includes(term));
    }, [allCategories, filterText]);

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && filterText.trim()) {
            e.preventDefault();
            const tag = filterText.trim();
            if (!allCategories.includes(tag)) {
                onAddNew(tag);
            } else if (!selectedCategories.includes(tag)) {
                onToggle(tag);
            }
            setFilterText('');
        }
    };

    return (
        <div className="w-full">
            <div className="flex flex-wrap gap-2 items-center min-h-[40px] p-2 border-b border-stone-200">
                {selectedCategories.map(cat => (
                    <span key={cat} className="bg-stone-600 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">
                        {cat}
                        <X size={12} className="cursor-pointer hover:text-stone-300" onClick={() => onToggle(cat)}/>
                    </span>
                ))}
                <button type="button" onClick={() => setIsOpen(!isOpen)} 
                    className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full transition-colors ${isOpen ? 'bg-stone-200 text-stone-600' : 'text-stone-500 hover:bg-stone-100'}`}>
                    <Plus size={12}/> {isOpen ? '收起' : '選擇分類'}
                </button>
            </div>
            {isOpen && (
                <div className="mt-2 p-3 bg-stone-50 rounded-xl border border-stone-200 shadow-sm animate-in fade-in slide-in-from-top-2">
                    <input type="text" placeholder="搜尋或輸入後按 Enter 建立" 
                        value={filterText} onChange={e => setFilterText(e.target.value)} onKeyDown={handleKeyDown}
                        className="w-full mb-3 p-2 bg-white rounded-lg text-sm outline-none border border-stone-200 focus:ring-1 focus:ring-stone-300" />
                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto content-start">
                        {filtered.map(cat => (
                            <button key={cat} type="button" 
                                onClick={() => { if(!selectedCategories.includes(cat)) onToggle(cat); }}
                                className={`text-xs px-3 py-1.5 rounded-full border transition ${selectedCategories.includes(cat) ? 'bg-stone-200 text-stone-400 border-transparent cursor-default' : 'bg-white text-stone-600 border-stone-200 hover:border-stone-400'}`}>
                                {cat}
                            </button>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- 主程式：ReadingTracker ---
export default function App() {
    const [user, setUser] = useState(null);
    const [books, setBooks] = useState([]);
    const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
    const [loading, setLoading] = useState(true);
    const [customId, setCustomId] = useState(localStorage.getItem('reading_tracker_id') || '');
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const [toast, setToast] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [isAddFormOpen, setIsAddFormOpen] = useState(false);
    const [modalType, setModalType] = useState(null);
    const [modalData, setModalData] = useState({});
    const [activeBookId, setActiveBookId] = useState(null);
    const [expandedBooks, setExpandedBooks] = useState({});

    const [newBook, setNewBook] = useState({
        title: '', author: '', wordCount: '', 
        addDate: new Date().toISOString().split('T')[0],
        reviewUrl: '', synopsis: '', category: [], isPinned: false
    });

    // 1. 初始化 Auth
    useEffect(() => {
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, (curr) => {
            setUser(curr);
            if (curr && customId) setIsLoggedIn(true);
        });
        return () => unsubscribe();
    }, []);

    // 2. 監聽 Firestore 數據 (Rule 1: Strict Paths)
    useEffect(() => {
        if (!user || !isLoggedIn || !customId) {
            setLoading(false);
            return;
        }

        setLoading(true);
        // 使用公用資料路徑，讓不同裝置只要輸入相同 ID 就能同步
        const booksRef = collection(db, 'artifacts', appId, 'public', 'data', `locker_${customId}_books`);
        const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', `locker_${customId}_settings`, 'general');

        const unsubBooks = onSnapshot(booksRef, (snapshot) => {
            const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            list.sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return new Date(b.addDate || 0) - new Date(a.addDate || 0);
            });
            setBooks(list);
            setLoading(false);
        }, (err) => {
            console.error("Firestore error:", err);
            showToast("讀取失敗，請檢查權限", "error");
        });

        const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().categories) {
                setCategories(docSnap.data().categories);
            }
        });

        return () => { unsubBooks(); unsubSettings(); };
    }, [user, isLoggedIn, customId]);

    const showToast = (message, type = 'info') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
    };

    const handleLogin = (e) => {
        e.preventDefault();
        if (customId.trim().length < 3) return showToast("ID 至少需要 3 個字元", "error");
        localStorage.setItem('reading_tracker_id', customId);
        setIsLoggedIn(true);
    };

    const handleLogout = () => {
        if (window.confirm("確定要登出並切換 ID 嗎？")) {
            setIsLoggedIn(false);
            setBooks([]);
        }
    };

    const addBook = async (e) => {
        e.preventDefault();
        if (!newBook.title) return;
        try {
            const booksRef = collection(db, 'artifacts', appId, 'public', 'data', `locker_${customId}_books`);
            await addDoc(booksRef, { 
                ...newBook, 
                status: 'reading', 
                createdAt: serverTimestamp() 
            });
            setNewBook({ title: '', author: '', wordCount: '', addDate: new Date().toISOString().split('T')[0], reviewUrl: '', synopsis: '', category: [], isPinned: false });
            setIsAddFormOpen(false);
            showToast("成功加入書櫃！");
        } catch (err) {
            showToast("新增失敗", "error");
        }
    };

    const updateCategories = async (newCats) => {
        const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', `locker_${customId}_settings`, 'general');
        await setDoc(settingsRef, { categories: newCats }, { merge: true });
    };

    const togglePin = async (book, e) => {
        e.stopPropagation();
        const bookRef = doc(db, 'artifacts', appId, 'public', 'data', `locker_${customId}_books`, book.id);
        await updateDoc(bookRef, { isPinned: !book.isPinned });
        showToast(book.isPinned ? "已取消釘選" : "已釘選至頂部");
    };

    const deleteBook = async (id) => {
        const bookRef = doc(db, 'artifacts', appId, 'public', 'data', `locker_${customId}_books`, id);
        await deleteDoc(bookRef);
        showToast("書籍已移除");
        setModalType(null);
    };

    const updateStatus = async (id, status, extraData = {}) => {
        const bookRef = doc(db, 'artifacts', appId, 'public', 'data', `locker_${customId}_books`, id);
        await updateDoc(bookRef, { status, ...extraData, isPinned: false });
        showToast("狀態已更新");
        setModalType(null);
    };

    const filteredBooks = useMemo(() => {
        return books.filter(b => {
            const matchStatus = statusFilter === 'all' || b.status === statusFilter;
            const term = searchTerm.toLowerCase();
            const matchSearch = !term || 
                b.title?.toLowerCase().includes(term) || 
                b.author?.toLowerCase().includes(term) ||
                (b.category && b.category.some(c => c.toLowerCase().includes(term)));
            return matchStatus && matchSearch;
        });
    }, [books, statusFilter, searchTerm]);

    const stats = useMemo(() => {
        const total = books.length;
        const finished = books.filter(b => b.status === 'finished').length;
        const reading = books.filter(b => b.status === 'reading').length;
        const dropped = books.filter(b => b.status === 'dropped').length;
        return { total, finished, reading, dropped };
    }, [books]);

    if (!isLoggedIn) {
        return (
            <div className="min-h-screen flex items-center justify-center p-6 bg-[#f2f0e9]">
                <div className="bg-white/80 backdrop-blur p-10 rounded-3xl shadow-xl border border-stone-200 w-full max-w-md text-center">
                    <BookOpen size={64} className="mx-auto text-stone-400 mb-6" />
                    <h1 className="text-3xl font-bold text-stone-800 mb-2 tracking-widest">雲端書櫃</h1>
                    <p className="text-stone-500 mb-8">輸入專屬 ID 開啟你的閱讀空間</p>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input 
                            value={customId} 
                            onChange={e => setCustomId(e.target.value)} 
                            placeholder="例如: alex_reading" 
                            className="w-full p-4 rounded-xl border border-stone-200 outline-none focus:ring-2 focus:ring-stone-300 text-center text-lg"
                        />
                        <button className="w-full bg-stone-700 text-white py-4 rounded-xl font-bold hover:bg-stone-800 transition">進入書房</button>
                    </form>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-[#f2f0e9] text-stone-800 font-sans pb-20">
            {/* Toast */}
            {toast && (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-top-4">
                    <div className={`px-6 py-3 rounded-full shadow-lg text-white font-medium ${toast.type === 'error' ? 'bg-red-500' : 'bg-stone-700'}`}>
                        {toast.message}
                    </div>
                </div>
            )}

            {/* Header */}
            <header className="sticky top-0 z-30 bg-[#f2f0e9]/90 backdrop-blur border-b border-stone-200 px-6 py-4">
                <div className="max-w-4xl mx-auto flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <BookOpen className="text-stone-600" />
                        <h1 className="text-xl font-bold tracking-widest hidden sm:block">我的閱讀手帳</h1>
                    </div>
                    <div className="flex items-center gap-4">
                        <div className="text-xs bg-stone-200 px-3 py-1 rounded-full text-stone-600">ID: {customId}</div>
                        <button onClick={handleLogout} className="text-stone-400 hover:text-stone-800"><LogOut size={20} /></button>
                    </div>
                </div>
            </header>

            <main className="max-w-4xl mx-auto p-6 space-y-8">
                {/* Stats */}
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    {[
                        { label: '正在讀', count: stats.reading, color: 'text-blue-600', icon: Hourglass },
                        { label: '已完食', count: stats.finished, color: 'text-green-600', icon: Trophy },
                        { label: '已棄書', count: stats.dropped, color: 'text-red-400', icon: BookX },
                        { label: '總計', count: stats.total, color: 'text-stone-600', icon: BookOpen },
                    ].map(s => (
                        <div key={s.label} className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm flex items-center justify-between">
                            <div>
                                <p className="text-xs text-stone-400 font-medium">{s.label}</p>
                                <p className={`text-2xl font-bold ${s.color}`}>{s.count}</p>
                            </div>
                            <s.icon size={24} className="opacity-10" />
                        </div>
                    ))}
                </div>

                {/* Add Book Form */}
                <section className="bg-white rounded-3xl border border-stone-200 shadow-sm overflow-hidden transition-all">
                    <div 
                        onClick={() => setIsAddFormOpen(!isAddFormOpen)}
                        className="p-5 flex justify-between items-center cursor-pointer hover:bg-stone-50"
                    >
                        <h2 className="font-bold flex items-center gap-2"><PenTool size={18} className="text-stone-500" /> 紀錄新發現</h2>
                        {isAddFormOpen ? <ChevronUp size={20} /> : <Plus size={20} />}
                    </div>
                    {isAddFormOpen && (
                        <form onSubmit={addBook} className="p-6 pt-0 space-y-5 animate-in fade-in zoom-in-95">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input placeholder="書名" value={newBook.title} onChange={e=>setNewBook({...newBook, title:e.target.value})} className="p-3 border-b border-stone-200 outline-none focus:border-stone-500" required />
                                <input placeholder="作者" value={newBook.author} onChange={e=>setNewBook({...newBook, author:e.target.value})} className="p-3 border-b border-stone-200 outline-none focus:border-stone-500" />
                            </div>
                            <CategoryPicker 
                                selectedCategories={newBook.category} 
                                onToggle={(cat) => setNewBook(prev => ({ ...prev, category: prev.category.includes(cat) ? prev.category.filter(c => c !== cat) : [...prev.category, cat] }))} 
                                allCategories={categories}
                                onAddNew={(name) => {
                                    const updated = [...categories, name];
                                    setCategories(updated);
                                    updateCategories(updated);
                                    setNewBook(prev => ({ ...prev, category: [...prev.category, name] }));
                                }}
                            />
                            <textarea 
                                placeholder="故事簡介或初步印象..." 
                                value={newBook.synopsis} 
                                onChange={e=>setNewBook({...newBook, synopsis:e.target.value})} 
                                className="w-full p-4 bg-stone-50 rounded-xl border border-stone-100 outline-none h-24 resize-none"
                            />
                            <div className="flex justify-end gap-3">
                                <button type="button" onClick={() => setIsAddFormOpen(false)} className="px-6 py-2 text-stone-400">取消</button>
                                <button type="submit" className="px-8 py-2 bg-stone-700 text-white rounded-xl shadow-md hover:bg-stone-800 transition">加入書櫃</button>
                            </div>
                        </form>
                    )}
                </section>

                {/* Filter Bar */}
                <div className="flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div className="flex gap-2 bg-stone-200/50 p-1 rounded-full w-full md:w-auto">
                        {['all', 'reading', 'finished', 'dropped'].map(f => (
                            <button 
                                key={f} 
                                onClick={() => setStatusFilter(f)}
                                className={`flex-1 md:flex-none px-4 py-1.5 rounded-full text-xs font-medium transition ${statusFilter === f ? 'bg-white text-stone-800 shadow-sm' : 'text-stone-500'}`}
                            >
                                {f === 'all' ? '全部' : f === 'reading' ? '待讀' : f === 'finished' ? '已完食' : '棄書'}
                            </button>
                        ))}
                    </div>
                    <div className="relative w-full md:w-64">
                        <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400" />
                        <input 
                            placeholder="搜尋書名或作者..." 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 rounded-full border border-stone-200 bg-white/50 outline-none focus:ring-2 focus:ring-stone-200 text-sm"
                        />
                    </div>
                </div>

                {/* Book List */}
                {loading ? (
                    <div className="py-20 text-center text-stone-400"><RefreshCw className="animate-spin mx-auto mb-4" /> 載入書櫃中...</div>
                ) : filteredBooks.length === 0 ? (
                    <div className="py-20 text-center text-stone-400 border-2 border-dashed border-stone-200 rounded-3xl">目前沒有符合條件的書籍</div>
                ) : (
                    <div className="grid grid-cols-1 gap-6">
                        {filteredBooks.map(book => (
                            <div 
                                key={book.id} 
                                className={`group bg-white p-6 rounded-3xl border transition-all duration-300 relative overflow-hidden flex flex-col sm:flex-row gap-6 ${book.isPinned ? 'border-stone-400 shadow-md ring-1 ring-stone-100' : 'border-stone-200 shadow-sm hover:shadow-md'}`}
                            >
                                {book.isPinned && <div className="absolute top-0 right-0 p-2 text-stone-300"><Pin size={16} className="fill-stone-300" /></div>}
                                
                                <div className="flex-1 space-y-3">
                                    <div className="flex flex-wrap gap-2">
                                        {book.category?.map(c => (
                                            <span key={c} className="text-[10px] bg-stone-100 text-stone-500 px-2 py-0.5 rounded uppercase tracking-tighter">{c}</span>
                                        ))}
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold text-stone-800 mb-1">{book.title}</h3>
                                        <p className="text-sm text-stone-400 flex items-center gap-1"><User size={12} /> {book.author || '未知作者'}</p>
                                    </div>
                                    {book.synopsis && (
                                        <p className="text-sm text-stone-500 line-clamp-2 italic leading-relaxed">
                                            「{book.synopsis}」
                                        </p>
                                    )}
                                    <div className="pt-2 flex items-center gap-4 text-xs text-stone-400">
                                        <span className="flex items-center gap-1"><Calendar size={12} /> {book.addDate} 加入</span>
                                        <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${book.status==='finished'?'bg-green-100 text-green-700':book.status==='dropped'?'bg-red-100 text-red-700':'bg-stone-100 text-stone-500'}`}>
                                            {book.status==='finished'?'已完食':book.status==='dropped'?'已棄書':'閱讀中'}
                                        </span>
                                    </div>
                                </div>

                                <div className="flex flex-row sm:flex-col gap-2 justify-end sm:w-24">
                                    {book.status === 'reading' ? (
                                        <>
                                            <button 
                                                onClick={() => { setActiveBookId(book.id); setModalType('finish'); }}
                                                className="flex-1 bg-green-50 text-green-600 p-2 rounded-xl hover:bg-green-100 transition flex items-center justify-center"
                                                title="完成閱讀"
                                            >
                                                <CheckCircle size={20} />
                                            </button>
                                            <button 
                                                onClick={() => { setActiveBookId(book.id); setModalType('drop'); }}
                                                className="flex-1 bg-red-50 text-red-600 p-2 rounded-xl hover:bg-red-100 transition flex items-center justify-center"
                                                title="決定棄書"
                                            >
                                                <BookX size={20} />
                                            </button>
                                        </>
                                    ) : (
                                        <button 
                                            onClick={() => updateStatus(book.id, 'reading')}
                                            className="flex-1 bg-stone-100 text-stone-600 p-2 rounded-xl hover:bg-stone-200 transition flex items-center justify-center"
                                            title="重讀一次"
                                        >
                                            <RotateCcw size={20} />
                                        </button>
                                    )}
                                    <button 
                                        onClick={(e) => togglePin(book, e)}
                                        className={`flex-1 p-2 rounded-xl border transition flex items-center justify-center ${book.isPinned ? 'bg-stone-700 text-white border-stone-800' : 'bg-white text-stone-400 border-stone-100 hover:border-stone-300'}`}
                                        title="釘選"
                                    >
                                        {book.isPinned ? <PinOff size={18} /> : <Pin size={18} />}
                                    </button>
                                    <button 
                                        onClick={() => { setActiveBookId(book.id); setModalType('delete'); }}
                                        className="flex-1 p-2 rounded-xl bg-white text-stone-300 hover:text-red-400 transition flex items-center justify-center border border-transparent hover:border-red-100"
                                        title="刪除"
                                    >
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </main>

            {/* Modals */}
            {modalType && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm" onClick={() => setModalType(null)}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl animate-in zoom-in-95" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold mb-4 text-center">
                            {modalType === 'finish' ? '太棒了！記錄完食' : modalType === 'drop' ? '緣分已盡？記錄棄書' : '確認刪除'}
                        </h3>
                        
                        {modalType === 'finish' && (
                            <div className="space-y-4 mb-6">
                                <div className="space-y-1">
                                    <label className="text-xs text-stone-400">完食日期</label>
                                    <input type="date" className="w-full p-2 border-b border-stone-200 outline-none" defaultValue={new Date().toISOString().split('T')[0]} id="finish-date" />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs text-stone-400">短評 (選填)</label>
                                    <textarea className="w-full p-3 bg-stone-50 rounded-xl border border-stone-100 outline-none h-20 text-sm" placeholder="這本書好在哪裡..." id="finish-review"></textarea>
                                </div>
                            </div>
                        )}

                        {modalType === 'drop' && (
                            <div className="space-y-4 mb-6">
                                <p className="text-sm text-stone-500 text-center">書海無涯，不合適就不勉強。記錄一下你在哪裡離開的？</p>
                                <input placeholder="例：第 45 章、第 120 頁" className="w-full p-3 bg-stone-50 rounded-xl border border-stone-100 outline-none text-center" id="drop-note" />
                            </div>
                        )}

                        {modalType === 'delete' && (
                            <p className="text-stone-500 text-center mb-6 italic">這本書將從書櫃中徹底消失，確定嗎？</p>
                        )}

                        <div className="flex gap-4">
                            <button onClick={() => setModalType(null)} className="flex-1 py-3 text-stone-400">取消</button>
                            <button 
                                onClick={() => {
                                    if (modalType === 'delete') deleteBook(activeBookId);
                                    else if (modalType === 'finish') {
                                        const date = document.getElementById('finish-date').value;
                                        const review = document.getElementById('finish-review').value;
                                        updateStatus(activeBookId, 'finished', { finishDate: date, review });
                                    }
                                    else if (modalType === 'drop') {
                                        const note = document.getElementById('drop-note').value;
                                        updateStatus(activeBookId, 'dropped', { dropPoint: note, dropDate: new Date().toISOString().split('T')[0] });
                                    }
                                }}
                                className={`flex-1 py-3 text-white rounded-xl shadow-md ${modalType === 'delete' ? 'bg-red-500' : 'bg-stone-700'}`}
                            >
                                確認執行
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}