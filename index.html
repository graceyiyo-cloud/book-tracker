<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的雲端書櫃</title>
    <!-- 引入 Tailwind CSS 與 Google Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- 修正：改用 cdnjs 鎖定 Babel 版本至 7.23.5，避免最新版本 (7.26+) 與 ES Modules 的相容性問題 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#f2f0e9] text-stone-800">
    <div id="root"></div>

    <!-- 修正：保留 data-type="module" 以支援 import，但移除額外的 data-presets 以使用預設值 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Search, Plus, Trash2, CheckCircle, BookX, 
            Calendar, User, LogIn, RefreshCw, TrendingUp, Link as LinkIcon, 
            FileText, PenTool, Trophy, Hourglass, Star, X, Tag, RotateCcw, 
            AlertTriangle, Filter, LogOut, MessageSquare, Edit3, ChevronDown, 
            ExternalLink, Pin, PinOff, ChevronUp 
        } from 'https://esm.sh/lucide-react@0.344.0';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- 初始化 Firebase ---
        // 修正：增加判斷邏輯。
        // 如果在 Canvas 預覽環境 (__firebase_config 存在) 則使用系統變數
        // 如果在本地電腦執行 (變數不存在) 則使用您原本提供的設定值
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDX1-Lwc5_u_fwV9P25xh32dVF8uVNT0QU",
            authDomain: "my-reading-tracker-58f69.firebaseapp.com",
            projectId: "my-reading-tracker-58f69",
            storageBucket: "my-reading-tracker-58f69.firebasestorage.app",
            messagingSenderId: "370802674969",
            appId: "1:370802674969:web:efb1c045e0028925154988",
            measurementId: "G-52EWLNG7ST"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // 修正：為了對應舊資料，將預設 appId 改回 'my-reading-app'
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-reading-app';

        const ESTIMATE_WORDS_PER_PAGE = 350;
        const DEFAULT_CATEGORIES = ["玄幻", "奇幻", "武俠", "仙俠", "都市", "言情", "古代", "架空", "科幻", "懸疑", "推理", "耽美", "百合", "穿越", "重生", "系統", "末世", "種田"];

        // 星級評分組件
        const StarRating = ({ rating, setRating, interactive = false, size = 16 }) => (
            <div className="flex gap-1">
                {[1, 2, 3, 4, 5].map((index) => {
                    const filled = rating >= index;
                    const half = rating >= index - 0.5 && !filled;
                    return (
                        <div key={index} className={`relative ${interactive ? 'cursor-pointer transition-transform active:scale-90' : ''}`}
                            onClick={(e) => {
                                if (!interactive) return;
                                const rect = e.currentTarget.getBoundingClientRect();
                                const val = (e.clientX - rect.left) < rect.width / 2 ? index - 0.5 : index;
                                setRating(val);
                            }}>
                            <Star size={size} className="text-stone-200" />
                            <div className="absolute top-0 left-0 overflow-hidden" style={{ width: filled ? '100%' : half ? '50%' : '0%' }}>
                                <Star size={size} className="fill-amber-400 text-amber-400" />
                            </div>
                        </div>
                    );
                })}
            </div>
        );

        // 分類選擇器組件
        const CategoryPicker = ({ selectedCategories, onToggle, allCategories, onAddNew }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [filterText, setFilterText] = useState('');
            const filtered = useMemo(() => allCategories.filter(c => c.includes(filterText)), [allCategories, filterText]);

            return (
                <div className="w-full">
                    <div className="flex flex-wrap gap-2 items-center min-h-[40px] p-2 border-b border-stone-200">
                        {selectedCategories.map(cat => (
                            <span key={cat} className="bg-stone-600 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">
                                {cat} <X size={12} className="cursor-pointer hover:text-stone-300" onClick={() => onToggle(cat)}/>
                            </span>
                        ))}
                        <button type="button" onClick={() => setIsOpen(!isOpen)} className="text-xs text-stone-500 hover:bg-stone-100 px-3 py-1.5 rounded-full transition-colors">
                            {isOpen ? '收起' : '+ 選擇分類'}
                        </button>
                    </div>
                    {isOpen && (
                        <div className="mt-2 p-4 bg-white rounded-2xl border border-stone-200 shadow-sm animate-in fade-in slide-in-from-top-1">
                            <input placeholder="搜尋或新增..." value={filterText} onChange={e => setFilterText(e.target.value)} 
                                onKeyDown={e => { if(e.key==='Enter' && filterText){ onAddNew(filterText); setFilterText(''); } }}
                                className="w-full mb-3 p-2 border rounded-lg text-sm outline-none focus:ring-1 focus:ring-stone-400" />
                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto no-scrollbar">
                                {filtered.map(cat => (
                                    <button key={cat} type="button" onClick={() => onToggle(cat)}
                                        className={`text-xs px-3 py-1.5 rounded-full border transition ${selectedCategories.includes(cat) ? 'bg-stone-700 text-white' : 'bg-white text-stone-600 border-stone-200 hover:border-stone-400'}`}>
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 主應用程式
        function App() {
            const [user, setUser] = useState(null);
            const [books, setBooks] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [loading, setLoading] = useState(true);
            const [customId, setCustomId] = useState(localStorage.getItem('reading_tracker_id') || '');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [toast, setToast] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [isAddFormOpen, setIsAddFormOpen] = useState(false);
            const [modalType, setModalType] = useState(null);
            const [modalData, setModalData] = useState({});
            const [activeBookId, setActiveBookId] = useState(null);
            const [newBook, setNewBook] = useState({ title: '', author: '', wordCount: '', addDate: new Date().toISOString().split('T')[0], synopsis: '', category: [] });

            // 1. 初始化驗證 (遵循 Rule 3)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Failed:", err);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (curr) => {
                    setUser(curr);
                    if (curr && customId) setIsLoggedIn(true);
                });
                return () => unsubscribe();
            }, []);

            // 2. 數據監聽 (遵循 Rule 1，並恢復為原始集合路徑結構)
            useEffect(() => {
                if (!user || !isLoggedIn || !customId) { setLoading(false); return; }
                
                // 修正：路徑改回 reading_list_${customId} 以讀取舊資料
                const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`);
                
                const unsub = onSnapshot(collectionRef, (snapshot) => {
                    const list = [];
                    let fetchedCategories = DEFAULT_CATEGORIES;

                    snapshot.docs.forEach(doc => {
                        // 修正：恢復原始邏輯，settings 是一份文件，不是獨立集合
                        if (doc.id === 'settings') {
                            if (doc.data().categories) fetchedCategories = doc.data().categories;
                        } else {
                            list.push({ id: doc.id, ...doc.data() });
                        }
                    });

                    setCategories(fetchedCategories);
                    setBooks(list.sort((a, b) => (b.isPinned ? 1 : -1) || new Date(b.addDate) - new Date(a.addDate)));
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    showToast("資料同步失敗");
                });
                return () => unsub();
            }, [user, isLoggedIn, customId]);

            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

            const handleLogin = (e) => {
                e.preventDefault();
                if (customId.trim().length < 3) return showToast("ID 過短");
                localStorage.setItem('reading_tracker_id', customId);
                setIsLoggedIn(true);
            };

            const addBook = async (e) => {
                e.preventDefault();
                if (!newBook.title || !user) return;
                try {
                    // 修正：寫入路徑改回 reading_list_${customId}
                    const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`);
                    await addDoc(collectionRef, { ...newBook, status: 'reading', createdAt: serverTimestamp() });
                    setNewBook({ title: '', author: '', wordCount: '', addDate: new Date().toISOString().split('T')[0], synopsis: '', category: [] });
                    setIsAddFormOpen(false);
                    showToast("成功加入書櫃！");
                } catch (err) {
                    showToast("儲存失敗");
                }
            };

            const updateStatus = async (id, status, extra = {}) => {
                // 修正：更新路徑改回 reading_list_${customId}
                const bookRef = doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, id);
                await updateDoc(bookRef, { status, ...extra, isPinned: false });
                setModalType(null);
                showToast("狀態已更新");
            };

            // 新增：處理分類更新 (寫入到 settings 文件)
            const handleUpdateCategories = async (newCats) => {
                setCategories(newCats);
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, 'settings');
                await setDoc(settingsRef, { categories: newCats }, { merge: true });
            };

            const filteredBooks = books.filter(b => (statusFilter === 'all' || b.status === statusFilter) && (b.title.includes(searchTerm) || b.author.includes(searchTerm)));

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-[#f2f0e9]">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-xl w-full max-w-md text-center border border-stone-200">
                            <BookOpen size={64} className="mx-auto text-stone-400 mb-6" />
                            <h1 className="text-4xl font-black mb-2 tracking-widest text-stone-800">雲端書櫃</h1>
                            <p className="text-stone-500 mb-8 font-medium">請輸入 ID 開啟你的閱讀空間</p>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input value={customId} onChange={e => setCustomId(e.target.value)} placeholder="你的專屬 ID" className="w-full p-4 rounded-2xl border text-center text-lg outline-none focus:ring-2 focus:ring-stone-400 transition-all" />
                                <button className="w-full bg-stone-700 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-stone-800 active:scale-95 transition-all">進入書房</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen max-w-4xl mx-auto p-6 space-y-8 pb-20 bg-[#f2f0e9]">
                    {toast && <div className="fixed top-8 left-1/2 -translate-x-1/2 z-50 bg-stone-800 text-white px-8 py-3 rounded-full shadow-2xl font-bold animate-in fade-in slide-in-from-top-2">{toast}</div>}
                    
                    <header className="flex justify-between items-center py-4 border-b border-stone-200">
                        <div className="flex items-center gap-2 font-black text-xl tracking-widest text-stone-700"><BookOpen /> 閱讀手帳</div>
                        <div className="flex items-center gap-4">
                            <div className="text-xs bg-stone-200 px-4 py-2 rounded-full font-bold text-stone-600">ID: {customId}</div>
                            <button onClick={() => { setIsLoggedIn(false); localStorage.removeItem('reading_tracker_id'); }} className="text-stone-400 hover:text-stone-800 transition-colors"><LogOut size={20} /></button>
                        </div>
                    </header>

                    {/* 新增區塊 */}
                    <section className="bg-white rounded-3xl border border-stone-200 shadow-sm overflow-hidden">
                        <div onClick={() => setIsAddFormOpen(!isAddFormOpen)} className="p-6 flex justify-between cursor-pointer font-bold hover:bg-stone-50 transition-colors">
                            <div className="flex items-center gap-2"><PenTool size={18} /> 紀錄新發現</div>
                            {isAddFormOpen ? <ChevronUp /> : <Plus />}
                        </div>
                        {isAddFormOpen && (
                            <form onSubmit={addBook} className="p-8 pt-0 space-y-4 border-t border-stone-50 pt-6 animate-in fade-in zoom-in-95">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-stone-400 uppercase tracking-tighter ml-1">書名</label>
                                        <input placeholder="書名" value={newBook.title} onChange={e=>setNewBook({...newBook, title:e.target.value})} className="w-full p-3 bg-stone-50 rounded-xl outline-none focus:ring-1 focus:ring-stone-300" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-stone-400 uppercase tracking-tighter ml-1">作者</label>
                                        <input placeholder="作者" value={newBook.author} onChange={e=>setNewBook({...newBook, author:e.target.value})} className="w-full p-3 bg-stone-50 rounded-xl outline-none focus:ring-1 focus:ring-stone-300" />
                                    </div>
                                </div>
                                {/* 修正：傳遞 onAddNew 處理分類更新 */}
                                <CategoryPicker 
                                    selectedCategories={newBook.category} 
                                    allCategories={categories} 
                                    onToggle={c => setNewBook(prev => ({...prev, category: prev.category.includes(c) ? prev.category.filter(x=>x!==c) : [...prev.category, c]}))} 
                                    onAddNew={c => handleUpdateCategories([...categories, c])} 
                                />
                                <textarea placeholder="故事大綱或初步印象..." value={newBook.synopsis} onChange={e=>setNewBook({...newBook, synopsis:e.target.value})} className="w-full p-4 bg-stone-50 rounded-xl h-24 outline-none resize-none focus:ring-1 focus:ring-stone-300" />
                                <div className="flex justify-end gap-2"><button type="submit" className="bg-stone-800 text-white px-10 py-3 rounded-2xl font-bold shadow-lg hover:bg-stone-900 active:scale-95 transition-all">存入書櫃</button></div>
                            </form>
                        )}
                    </section>

                    {/* 篩選與搜尋 */}
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex gap-2 bg-stone-200/50 p-1.5 rounded-2xl w-full md:w-auto shadow-inner">
                            {['all', 'reading', 'finished', 'dropped'].map(f => (
                                <button key={f} onClick={() => setStatusFilter(f)} className={`flex-1 md:flex-none px-5 py-2 rounded-xl text-xs font-bold transition-all ${statusFilter===f ? 'bg-white shadow-md text-stone-900' : 'text-stone-400 hover:text-stone-600'}`}>
                                    {f==='all'?'全部':f==='reading'?'閱讀中':f==='finished'?'已完食':'棄書'}
                                </button>
                            ))}
                        </div>
                        <div className="relative flex-1 max-w-xs group w-full md:w-auto">
                            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-300 group-focus-within:text-stone-500 transition-colors"/>
                            <input placeholder="搜尋書名或作者..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-2xl bg-white border border-stone-200 outline-none text-sm focus:ring-2 focus:ring-stone-200 transition-all" />
                        </div>
                    </div>

                    {/* 書籍列表 */}
                    {loading ? (
                        <div className="py-20 text-center text-stone-400"><RefreshCw className="animate-spin mx-auto mb-2" /> 載入中...</div>
                    ) : (
                        <div className="grid gap-6">
                            {filteredBooks.map(book => (
                                <div key={book.id} className="bg-white p-6 md:p-8 rounded-[2.5rem] border border-stone-200 shadow-sm hover:shadow-md transition-all flex flex-col sm:flex-row gap-6 relative group overflow-hidden">
                                    <div className={`absolute left-0 top-0 bottom-0 w-2 transition-all ${book.status==='finished'?'bg-emerald-500':book.status==='dropped'?'bg-rose-500':'bg-stone-200 group-hover:bg-stone-400'}`}></div>
                                    <div className="flex-1 space-y-3">
                                        <div className="flex flex-wrap gap-2">{book.category?.map(c=><span key={c} className="text-[10px] bg-stone-50 px-3 py-1 rounded-full font-bold text-stone-400 uppercase tracking-tighter">{c}</span>)}</div>
                                        <h3 className="text-2xl font-black text-stone-800">{book.title}</h3>
                                        <div className="flex items-center gap-4 text-sm text-stone-400 font-medium">
                                            <span className="flex items-center gap-1"><User size={14}/> {book.author || '佚名'}</span>
                                            <span className="flex items-center gap-1"><Calendar size={14}/> {book.addDate}</span>
                                        </div>
                                        {book.synopsis && <p className="text-sm text-stone-500 italic leading-relaxed line-clamp-2">「{book.synopsis}」</p>}
                                        {book.status === 'finished' && book.rating && <StarRating rating={book.rating} />}
                                    </div>
                                    <div className="flex sm:flex-col gap-2 justify-end sm:w-20">
                                        {book.status === 'reading' ? (
                                            <>
                                                <button onClick={() => { setActiveBookId(book.id); setModalType('finish'); }} className="flex-1 bg-emerald-50 text-emerald-600 p-3 rounded-2xl hover:bg-emerald-500 hover:text-white transition-all shadow-sm flex items-center justify-center" title="完食"><CheckCircle size={22}/></button>
                                                <button onClick={() => { setActiveBookId(book.id); setModalType('drop'); }} className="flex-1 bg-rose-50 text-rose-500 p-3 rounded-2xl hover:bg-rose-500 hover:text-white transition-all shadow-sm flex items-center justify-center" title="棄書"><BookX size={22}/></button>
                                            </>
                                        ) : (
                                            <button onClick={() => updateStatus(book.id, 'reading')} className="flex-1 bg-stone-100 p-3 rounded-2xl hover:bg-stone-700 hover:text-white transition-all shadow-sm flex items-center justify-center" title="重讀"><RotateCcw size={22}/></button>
                                        )}
                                        <button onClick={async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, book.id))} className="flex-1 bg-stone-50 p-3 rounded-2xl text-stone-200 hover:text-rose-500 hover:bg-rose-50 transition-all border border-stone-50 hover:border-rose-100 flex items-center justify-center" title="刪除"><Trash2 size={20}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* 彈窗系統 */}
                    {modalType && (
                        <div className="fixed inset-0 z-50 bg-stone-900/40 backdrop-blur-md flex items-center justify-center p-6 animate-in fade-in" onClick={()=>setModalType(null)}>
                            <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl space-y-6 animate-in zoom-in-95" onClick={e=>e.stopPropagation()}>
                                <div className="w-12 h-1 bg-stone-100 rounded-full mx-auto mb-4"></div>
                                <h3 className="text-2xl font-black text-center text-stone-800">{modalType==='finish'?'太棒了！記錄完食':'緣分已盡？記錄棄書'}</h3>
                                {modalType==='finish' && (
                                    <div className="flex flex-col items-center gap-6">
                                        <div className="flex flex-col items-center gap-2">
                                            <p className="text-[10px] text-stone-400 uppercase font-black tracking-widest">給這本書的評價</p>
                                            <StarRating rating={modalData.rating || 0} setRating={r => setModalData({...modalData, rating: r})} interactive={true} size={28} />
                                        </div>
                                        <textarea id="review" placeholder="寫點閱讀心得吧..." className="w-full p-4 bg-stone-50 rounded-2xl h-28 outline-none text-sm resize-none focus:ring-1 focus:ring-stone-400" />
                                    </div>
                                )}
                                {modalType==='drop' && (
                                    <div className="space-y-4">
                                        <p className="text-sm text-stone-500 text-center leading-relaxed">書海無涯，不合適就不勉強。<br/>記錄一下你在哪裡離開的？</p>
                                        <input id="drop-note" placeholder="例：第 45 章、節奏太慢..." className="w-full p-3 bg-stone-50 rounded-xl outline-none text-center focus:ring-1 focus:ring-stone-400 font-bold" />
                                    </div>
                                )}
                                <div className="flex gap-4 pt-4">
                                    <button onClick={()=>setModalType(null)} className="flex-1 font-bold text-stone-400 hover:text-stone-600 transition-colors">取消</button>
                                    <button onClick={() => {
                                        if (modalType === 'finish') {
                                            const r = document.getElementById('review')?.value || '';
                                            updateStatus(activeBookId, 'finished', { review: r, rating: modalData.rating || 0, finishDate: new Date().toISOString().split('T')[0] });
                                        } else {
                                            const n = document.getElementById('drop-note')?.value || '';
                                            updateStatus(activeBookId, 'dropped', { dropPoint: n, dropDate: new Date().toISOString().split('T')[0] });
                                        }
                                    }} className="flex-1 py-4 bg-stone-800 text-white rounded-[1.5rem] font-black shadow-lg hover:bg-black active:scale-95 transition-all">確認</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>